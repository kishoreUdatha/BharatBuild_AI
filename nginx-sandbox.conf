server {
    listen 8080;
    server_name _;

    # Medium #19: Enable sub_filter for more content types
    sub_filter_once off;
    sub_filter_types text/html application/javascript text/javascript text/css application/json;

    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # HIGH #3: Dedicated WebSocket location for Vite HMR
    # This ensures HMR connections are properly proxied without sub_filter interference
    location ~ ^/sandbox/([0-9]+)/__vite_hmr$ {
        set $target_port $1;

        # CRITICAL #3: Validate WebSocket upgrade header
        if ($http_upgrade = "") {
            return 400 "WebSocket upgrade required";
        }

        proxy_pass http://127.0.0.1:$target_port/__vite_hmr;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # HIGH #3: Long timeouts for WebSocket connections
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
        proxy_connect_timeout 7d;

        # HIGH #3: Disable buffering for WebSocket
        proxy_buffering off;
        proxy_cache off;
    }

    # HIGH #3: Dedicated WebSocket location for webpack HMR
    location ~ ^/sandbox/([0-9]+)/ws$ {
        set $target_port $1;

        # CRITICAL #3: Validate WebSocket upgrade header
        if ($http_upgrade = "") {
            return 400 "WebSocket upgrade required";
        }

        proxy_pass http://127.0.0.1:$target_port/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
        proxy_connect_timeout 7d;

        proxy_buffering off;
        proxy_cache off;
    }

    # HIGH #3: Dedicated location for sockjs (webpack dev server)
    location ~ ^/sandbox/([0-9]+)/sockjs-node(/.*)?$ {
        set $target_port $1;
        set $sockjs_path $2;

        if ($sockjs_path = '') {
            set $sockjs_path /;
        }

        # CRITICAL #3: Validate WebSocket upgrade header for sockjs
        if ($http_upgrade = "") {
            return 400 "WebSocket upgrade required";
        }

        proxy_pass http://127.0.0.1:$target_port/sockjs-node$sockjs_path;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
        proxy_connect_timeout 7d;

        proxy_buffering off;
        proxy_cache off;
    }

    location ~ ^/sandbox/([0-9]+)(/.*)?$ {
        set $target_port $1;
        set $path $2;

        if ($path = '') {
            set $path /;
        }

        # Medium #19: Comprehensive asset path rewriting
        # HTML attributes
        sub_filter 'src="/' 'src="./';
        sub_filter 'href="/' 'href="./';
        sub_filter "src='/" "src='./";
        sub_filter "href='/" "href='./";

        # ES module imports
        sub_filter "from '/" "from './";
        sub_filter 'from "/' 'from "./';
        sub_filter "import '/" "import './";
        sub_filter 'import "/' 'import "./';

        # Dynamic imports
        sub_filter "import('/" "import('./";
        sub_filter 'import("/' 'import("./';

        # CSS url()
        sub_filter "url('/" "url('./";
        sub_filter 'url("/' 'url("./';
        sub_filter 'url(/' 'url(./';

        # Vite-specific rewrites
        sub_filter '/@vite/' './@vite/';
        sub_filter '/@react-refresh' './@react-refresh';
        sub_filter '/@id/' './@id/';

        # HIGH #3: Rewrite HMR WebSocket URLs to use relative paths
        sub_filter 'new WebSocket("ws://' 'new WebSocket("wss://'+window.location.host+"/sandbox/$target_port';
        sub_filter "new WebSocket('ws://" "new WebSocket('wss://'+window.location.host+'/sandbox/$target_port";

        proxy_pass http://127.0.0.1:$target_port$path$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Accept-Encoding "";
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;

        # HIGH #3: Disable buffering for WebSocket connections in main location too
        # Check if this is a WebSocket upgrade request
        set $ws_buffering "on";
        if ($http_upgrade = "websocket") {
            set $ws_buffering "off";
        }

        # Medium #19: Buffer settings for sub_filter to work on larger responses
        # Note: These are only applied for non-WebSocket requests
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }
}
